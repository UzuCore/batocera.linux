#!/bin/sh

# The RG40XX-H has swapped audio channels for speakers, but not for headphones.
#
# The new kernel in version 1.0.3 of the stock firmware resolves this bug, but
# we currently use a patched version of an older stock kernel (to fix cardinal
# snapping issues), and upgrading it isn't trivial.
#
# For now, poll spk_state (0 -> headphones plugged, 1 -> headphones unplugged)
# and swap DACL and DACR when the state changes.
DAEMON=/usr/bin/rg40h-spk-daemon.sh
PIDFILE=/var/run/rg40h-spk-daemon.pid

case "$1" in
    start)
        if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")"; then
            echo "Daemon is already running."
            exit 1
        fi
        echo "Starting daemon..."
        nohup "$DAEMON" > /dev/null 2>&1 &
        echo $! > "$PIDFILE"
        echo "Daemon started with PID $(cat "$PIDFILE")"
        ;;
    stop)
        if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")"; then
            echo "Stopping daemon..."
            kill "$(cat "$PIDFILE")"
            rm -f "$PIDFILE"
            echo "Daemon stopped."
        else
            echo "Daemon is not running."
        fi
        ;;
    reload)
        if [ -f "$PIDFILE" ] && kill -0 "$(cat "$PIDFILE")"; then
            echo "Reloading daemon..."
            kill -HUP "$(cat "$PIDFILE")"
        else
            echo "Daemon is not running."
        fi
        ;;
    *)
        echo "Usage: S98rg40h-spk-daemon {start|stop|reload}" >&2
        exit 1
        ;;
esac
